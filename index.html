<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Terminal</title>
    <link rel="icon" href="icon.png" type="image/png" />

    <!-- å˜—è©¦åŠ è¼‰æœ¬åœ°çš„ marked.min.jsï¼Œè‹¥ä¸å¯ç”¨å‰‡å¾ CDN åŠ è¼‰ -->
    <script>
      try {
        // å˜—è©¦åŠ è¼‰æœ¬åœ°çš„ marked.min.js
        const script = document.createElement('script');
        script.src = './marked.min.js';
        document.head.appendChild(script);
      } catch (error) {
        // è‹¥æœ¬åœ°æ¨™è¨˜åŠ è¼‰å¤±æ•—ï¼Œä½¿ç”¨ CDN
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js';
        document.head.appendChild(script);
      }
    </script>

    <style>
      body {
        margin: 0;
        background-color: #1a1a1a; /* ç¶­æŒ Linux å‘½ä»¤è¡Œé¢¨æ ¼ */
        color: #0f0;
        font-family: 'Comic Sans MS', cursive, sans-serif; /* å¯æ„›çš„å­—é«” */
        display: flex;
        flex-direction: column;
        height: 100vh;
      }
      #header {
        display: flex;
        justify-content: center;
        padding: 10px;
        background-color: #1a1a1a; /* é»‘ç°è‰²èƒŒæ™¯ */
      }
      #model-select {
        width: 30%; /* è¨­ç‚º30%å¯¬åº¦ */
        padding: 10px;
        font-size: 16px;
        background-color: #333; /* é»‘ç°è‰²èƒŒæ™¯ */
        color: white;
        font-weight: bold; /* ç²—é«”å­— */
        border: 1px solid #0f0;
        border-radius: 5px;
        cursor: pointer;
      }
      #model-select:hover {
        background-color: #444;
      }
      #display-area {
        flex: 8;
        overflow-y: auto;
        padding: 10px;
        border-bottom: 1px solid #0f0;
        background-color: #222; /* é»‘ç°è‰²èƒŒæ™¯ */
        border-radius: 10px 10px 0 0;
        white-space: pre-wrap; /* ä¿æŒæ–‡æœ¬æ ¼å¼ */
      }
      #input-area {
        flex: 2;
        display: flex;
        flex-direction: column;
        background-color: #111;
        border-radius: 0 0 10px 10px;
        padding: 10px;
        justify-content: center;
        align-items: center;
        gap: 10px; /* ä½¿æŒ‰éˆ•é–“è·æ›´å¤§ */
      }
      textarea {
        flex: 1;
        resize: none;
        padding: 10px;
        font-size: 16px;
        background-color: #333;
        color: #0f0;
        border: none;
        outline: none;
        border-radius: 5px;
        width: 100%;
        font-family: 'Comic Sans MS', cursive, sans-serif; /* å¯æ„›å­—é«” */
      }
      button {
        padding: 10px 20px;
        font-size: 16px;
        background-color: #00bfff; /* å¤©è—è‰²èƒŒæ™¯ */
        color: white;
        font-weight: bold; /* ç²—é«”å­— */
        border: 1px solid #0f0;
        cursor: pointer;
        border-radius: 5px;
        margin: 0 10px; /* åˆé©çš„é–“è· */
      }
      button:hover {
        background-color: #1e90ff; /* è¼•å¾®è®Šè‰² */
      }
      .button-container {
        display: flex;
        justify-content: center; /* å±…ä¸­é¡¯ç¤ºæŒ‰éˆ• */
        width: 100%;
      }
      @media (max-width: 768px) {
        button,
        textarea,
        #model-select {
          font-size: 14px;
        }
      }
    </style>
  </head>
  <body>
    <!-- é ‚éƒ¨ä¸‹æ‹‰é¸å–® -->
    <div id="header">
      <select id="model-select">
        <option value="gpt-4o-mini">gpt-4o-mini</option>
        <option value="claude-3-haiku">claude-3-haiku</option>
        <option value="llama-3.1-70b">llama-3.1-70b</option>
        <option value="mixtral-8x7b">mixtral-8x7b</option>
      </select>
    </div>

    <div id="display-area">
      <p>Responses will appear here...</p>
    </div>
    <div id="input-area">
      <textarea id="input-text" placeholder="è¼¸å…¥æ‚¨çš„å…§å®¹..."></textarea>
      <div class="button-container">
        <button id="submit-button">Send âœˆï¸</button>
        <button id="reset-button">Reset â™»ï¸</button>
        <button id="clean-button">Clean ğŸ§¹</button>
      </div>
    </div>

    <script>
      let messageHistory = [];
      let selectedModel = "gpt-4o-mini"; // é»˜èªæ¨¡å‹é¸æ“‡
      let apiUrl = ""; // é è¨­ç‚ºç©ºï¼Œå¾…å¾ URL åƒæ•¸è¨­ç½®
      let backupApiUrl = ""; // å‚™ç”¨ API åŸŸå

      // å¾ URL åƒæ•¸ç²å– API åŸŸå
      const urlParams = new URLSearchParams(window.location.search);
      const firstApi = urlParams.get('first');  // å¾ URL åƒæ•¸ä¸­ç²å– 'first' API
      const secondApi = urlParams.get('second'); // å¾ URL åƒæ•¸ä¸­ç²å– 'second' API

      // è¨­å®š API åŸŸå
      apiUrl = "https://" + firstApi + "/v1/chat/completions"; // é»˜èªå„ªå…ˆä½¿ç”¨ 'first'
      backupApiUrl = "https://" + secondApi + "/v1/chat/completions"; // å‚™ç”¨çš„ 'second' API

      // å˜—è©¦è¨ªå• API ä¾†æª¢æŸ¥å…¶å¯ç”¨æ€§
      const testApi = async (url) => {
        try {
          const response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              messages: [{ role: "user", content: "test" }],
              model: selectedModel,
            }),
          });

          if (!response.ok) throw new Error("API ç„¡æ³•é€£æ¥");
          return true;
        } catch (error) {
          return false; // å¦‚æœç„¡æ³•é€£æ¥ï¼Œè¿”å› false
        }
      };

      // è¨­å®šé¦–é¸å’Œå‚™ç”¨ API
      const setApiUrl = async () => {
        if (await testApi(apiUrl)) {
          console.log("ä½¿ç”¨é¦–é¸ API:", apiUrl);
        } else if (await testApi(backupApiUrl)) {
          apiUrl = backupApiUrl;
          console.log("ä½¿ç”¨å‚™ç”¨ API:", apiUrl);
        } else {
          alert("ç„¡æ³•é€£æ¥åˆ° APIï¼Œè«‹æª¢æŸ¥ API è¨­å®šã€‚");
        }
      };

      setApiUrl(); // åˆå§‹åŒ–æ™‚æ¸¬è©¦ API å¯ç”¨æ€§

      // ç›£è½æ¨¡å‹é¸æ“‡è®Šæ›´
      document.getElementById("model-select").addEventListener("change", (event) => {
        selectedModel = event.target.value;
      });

      // è™•ç†é¡¯ç¤ºå€åŸŸå…§çš„è¨Šæ¯ä¸¦è§£æ Markdown
      const displayMarkdown = (message) => {
        return marked.parse(message); // è§£æ Markdown
      };

      // ç™¼é€è¨Šæ¯
      document.getElementById("submit-button").addEventListener("click", async () => {
        const inputText = document.getElementById("input-text").value;
        const displayArea = document.getElementById("display-area");

        if (!inputText.trim()) {
          alert("è«‹è¼¸å…¥ä¸€äº›å…§å®¹ã€‚");
          return;
        }

        // è¨˜éŒ„è¨Šæ¯ä¸¦é¡¯ç¤ºç”¨æˆ¶è¨Šæ¯
        messageHistory.push({ role: "user", content: inputText });
        displayArea.innerHTML += `<p><strong>user@127.0.0.1:</strong> ${displayMarkdown(inputText)}</p>`;

        try {
          const response = await fetch(apiUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              messages: messageHistory,
              model: selectedModel, // ä½¿ç”¨é¸æ“‡çš„æ¨¡å‹
            }),
          });

          if (response.ok) {
            const data = await response.json();
            const reply =
              data?.choices?.[0]?.message?.content || "ç„¡å›æ‡‰";

            // è¨˜éŒ„å›è¦†ä¸¦é¡¯ç¤º
            messageHistory.push({ role: "assistant", content: reply });

            // è§£æ Markdown ä¸¦é¡¯ç¤ºå›è¦†
            displayArea.innerHTML += `<p><strong>client@localhost:</strong> ${displayMarkdown(reply)}</p>`;
          } else {
            displayArea.innerHTML += `<p><strong>client@localhost:</strong> éŒ¯èª¤: ${response.statusText}</p>`;
          }
        } catch (error) {
          displayArea.innerHTML += `<p><strong>client@localhost:</strong> ç¶²è·¯éŒ¯èª¤: ${error.message}</p>`;
        }

        document.getElementById("input-text").value = "";
        displayArea.scrollTop = displayArea.scrollHeight;
      });

      // é‡ç½®åŠŸèƒ½ (ä¸æ¸…é™¤é¡¯ç¤ºå…§å®¹)
      document.getElementById("reset-button").addEventListener("click", () => {
        messageHistory = [];
        document.getElementById("input-text").value = ""; // æ¸…ç©ºè¼¸å…¥æ¡†
      });

      // æ¸…ç©ºé¡¯ç¤ºå€åŸŸ
      document.getElementById("clean-button").addEventListener("click", () => {
        document.getElementById("display-area").innerHTML =
          "<p>Responses will appear here...</p>";
      });
    </script>
  </body>
</html>
